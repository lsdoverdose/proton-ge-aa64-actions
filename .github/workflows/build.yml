name: Build Proton-GE WoW64 AArch64

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '编译平台'
        required: true
        default: 'Glibc'
        type: choice
        options: [Glibc, Bionic]
      archive_type:
        description: '打包方式'
        required: true
        default: 'tar.xz'
        type: choice
        options: [tar, tar.xz, tar.zst, tar.gz, tar.lz, zip]
      compression_level:
        description: '压缩等级 (1-9)'
        required: false
        default: '9'
      artifact_output:
        description: '打包产物'
        required: true
        default: 'out+log'
        type: choice
        options: [out, log, out+log, bin, bin+log, all]
      retention_days:
        description: '产物存留时间 (天, -1为永久)'
        required: false
        default: '90'
      build_target:
        description: '编译内容'
        required: true
        default: 'Wine+PE'
        type: choice
        options: [Wine+PE, Wine]
      enable_ntsync:
        description: '启用 NTSYNC'
        type: boolean
        default: true
      enable_fsync:
        description: '启用 FSYNC'
        type: boolean
        default: true
      disable_ccache:
        description: '关闭 Ccache'
        type: boolean
        default: false
      disable_lto:
        description: '关闭 LTO'
        type: boolean
        default: false
      use_dbs:
        description: '使用 DBS (Distro Build System)'
        type: boolean
        default: false
      use_abs:
        description: '使用 ABS (Arch Build System)'
        type: boolean
        default: false
      exclude_hangover:
        description: '不打包 Hangover 到 Wine'
        type: boolean
        default: false
      hangover_emulator:
        description: 'Hangover 模拟器类型'
        required: false
        default: 'fex'
        type: choice
        options: [fex, box64, qemu]

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  INSTALL_DIR: ${{ github.workspace }}/install
  SOURCE_DIR: ${{ github.workspace }}/sources
  BUILD_DIR: ${{ github.workspace }}/build

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        run: |
          # 添加 ARM64 架构支持
          sudo dpkg --add-architecture arm64
          
          # 修复软件源：为默认源添加 amd64 限制，并添加 ports 源用于 arm64
          sudo tee /etc/apt/sources.list.d/ubuntu.sources << 'EOF'
          Types: deb
          URIs: http://archive.ubuntu.com/ubuntu/
          Suites: noble noble-updates noble-backports
          Components: main restricted universe multiverse
          Architectures: amd64
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

          Types: deb
          URIs: http://security.ubuntu.com/ubuntu/
          Suites: noble-security
          Components: main restricted universe multiverse
          Architectures: amd64
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

          Types: deb
          URIs: http://ports.ubuntu.com/ubuntu-ports/
          Suites: noble noble-updates noble-backports
          Components: main restricted universe multiverse
          Architectures: arm64
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

          Types: deb
          URIs: http://ports.ubuntu.com/ubuntu-ports/
          Suites: noble-security
          Components: main restricted universe multiverse
          Architectures: arm64
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
          EOF
          
          sudo apt-get update
          
          # 安装交叉编译工具 (amd64 架构)
          sudo apt-get install -y \
            ccache clang lld llvm \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            mingw-w64 mingw-w64-tools \
            flex bison gettext libpcsclite-dev \
            libvulkan-dev libvulkan1 \
            cmake ninja-build git \
            zstd xz-utils unzip
          
          # 安装 ARM64 架构的运行时库 (用于交叉编译链接)
          sudo apt-get install -y \
            libc6:arm64 \
            libstdc++6:arm64
          
          # 注意：GitHub Actions 的 Ubuntu 24.04 可能没有 llvm-mingw，需要手动安装或从源码构建
          # 暂时使用 mingw-w64 替代
          
          if [[ "${{ github.event.inputs.platform }}" == "Bionic" ]]; then
            echo "ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME" >> $GITHUB_ENV
            echo "ANDROID_NDK_ROOT=$ANDROID_NDK_LATEST_HOME" >> $GITHUB_ENV
          fi


      - name: Cache Ccache
        if: github.event.inputs.disable_ccache == 'false'
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ github.event.inputs.platform }}-${{ github.sha }}
          restore-keys: ccache-${{ github.event.inputs.platform }}-

      - name: Prepare Sources
        run: |
          mkdir -p $SOURCE_DIR $BUILD_DIR $INSTALL_DIR
          cd $SOURCE_DIR
          
          # 克隆 Proton-GE (包含 Wine 子模块)
          git clone --recurse-submodules --depth=1 https://github.com/gloriouseggroll/proton-ge-custom
          
          # 克隆 Hangover (包含子模块)
          if [[ "${{ github.event.inputs.exclude_hangover }}" == "false" ]]; then
            git clone --recurse-submodules --depth=1 https://github.com/AndreRH/hangover.git hangover-src
          fi
          
          # 应用 Proton-GE 补丁
          cd proton-ge-custom
          ./patches/protonprep-valve-staging.sh || true
          
          # NTSYNC 补丁
          if [[ "${{ github.event.inputs.enable_ntsync }}" == "true" ]]; then
            echo "Applying NTSYNC patches..."
            # 这里应该应用实际的 NTSYNC 补丁
            # patch -p1 < patches/ntsync.patch || true
          fi

      - name: Build Hangover Emulator DLLs (PE)
        if: github.event.inputs.exclude_hangover == 'false'
        run: |
          cd $SOURCE_DIR/hangover-src
          
          # 初始化子模块 (Box64/FEX)
          git submodule update --init --recursive || true
          
          EMULATOR="${{ github.event.inputs.hangover_emulator }}"
          
          case $EMULATOR in
            fex)
              echo "Building FEX Emulators..."
              # FEX ARM64EC (x86_64 模拟)
              mkdir -p build-arm64ec && cd build-arm64ec
              cmake -GNinja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
                -DMINGW_TRIPLE=arm64ec-w64-mingw32 \
                -DENABLE_LTO=${{ github.event.inputs.disable_lto == 'false' && 'True' || 'False' }} \
                -DBUILD_TESTING=False \
                -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
                -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR \
                ..
              ninja libarm64ecfex || make -j$(nproc) libarm64ecfex
              
              cd ..
              # FEX WOW64 (x86 模拟)
              mkdir -p build-wow64 && cd build-wow64
              cmake -GNinja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
                -DMINGW_TRIPLE=aarch64-w64-mingw32 \
                -DENABLE_LTO=${{ github.event.inputs.disable_lto == 'false' && 'True' || 'False' }} \
                -DBUILD_TESTING=False \
                -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
                -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR \
                ..
              ninja libwow64fex || make -j$(nproc) libwow64fex
              ;;
              
            box64)
              echo "Building Box64..."
              # Box64 作为 PE DLL 构建
              mkdir -p build && cd build
              cmake -GNinja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
                -DMINGW_TRIPLE=aarch64-w64-mingw32 \
                -DBUILD_TESTING=False \
                ..
              ninja wowbox64 || make -j$(nproc) wowbox64
              ;;
              
            qemu)
              echo "Building QEMU (已弃用，不建议使用)..."
              mkdir -p qemu/build && cd qemu/build
              ../configure --disable-werror --target-list=i386-linux-user
              make -j$(nproc)
              ;;
          esac

      - name: Build Wine Native (Tools)
        run: |
          cd $SOURCE_DIR/proton-ge-custom/wine
          mkdir -p build-native && cd build-native
          
          # 首先构建原生 Wine 工具 (wine-tools)
          ../configure \
            --prefix=$BUILD_DIR/wine-tools \
            --enable-win64 \
            --disable-tests \
            --without-x \
            --without-wayland \
            --without-vulkan \
            --disable-winevdm
          
          make -j$(nproc) __tooldeps__
          make install __tooldeps__

      - name: Build Wine Hangover (WoW64 AArch64)
        run: |
          cd $SOURCE_DIR/proton-ge-custom/wine
          mkdir -p build-hangover && cd build-hangover
          
          # 配置编译选项
          CONF_FLAGS="--prefix=$INSTALL_DIR \
            --host=aarch64-linux-gnu \
            --enable-archs=arm64ec,aarch64,i386 \
            --with-mingw=clang \
            --disable-tests"
          
          # 平台特定选项
          if [[ "${{ github.event.inputs.platform }}" == "Bionic" ]]; then
            CONF_FLAGS="$CONF_FLAGS --without-x --without-curses --with-vulkan"
          else
            CONF_FLAGS="$CONF_FLAGS --with-x --with-vulkan --with-pulse"
          fi
          
          # NTSYNC/FSYNC
          if [[ "${{ github.event.inputs.enable_ntsync }}" == "true" ]]; then
            CONF_FLAGS="$CONF_FLAGS --with-ntsync"
          fi
          
          if [[ "${{ github.event.inputs.enable_fsync }}" == "true" ]]; then
            CONF_FLAGS="$CONF_FLAGS --with-fsync"
          fi
          
          # 使用 Ccache
          if [[ "${{ github.event.inputs.disable_ccache }}" == "false" ]]; then
            export CC="ccache aarch64-linux-gnu-gcc"
            export CXX="ccache aarch64-linux-gnu-g++"
          else
            export CC="aarch64-linux-gnu-gcc"
            export CXX="aarch64-linux-gnu-g++"
          fi
          
          # 编译器优化
          OPT_FLAGS="-O3 -march=armv8.3-a"
          if [[ "${{ github.event.inputs.disable_lto }}" == "false" ]]; then
            OPT_FLAGS="$OPT_FLAGS -flto=thin"
          fi
          
          export CFLAGS="$OPT_FLAGS"
          export CXXFLAGS="$OPT_FLAGS"
          export LDFLAGS="-fuse-ld=lld"
          
          # 设置工具路径
          export WINE_TOOLS=$BUILD_DIR/wine-tools
          
          # 配置
          ../configure $CONF_FLAGS
          
          # 编译
          if [[ "${{ github.event.inputs.build_target }}" == "Wine" ]]; then
            make -j$(nproc)
          else
            # Wine+PE: 编译所有组件包括 PE 模块
            make -j$(nproc) all
          fi
          
          make install

      - name: Merge Hangover Artifacts
        if: github.event.inputs.exclude_hangover == 'false'
        run: |
          EMULATOR="${{ github.event.inputs.hangover_emulator }}"
          
          case $EMULATOR in
            fex)
              # 复制 FEX DLLs
              mkdir -p $INSTALL_DIR/lib/wine/aarch64-windows/
              if [ -f "$SOURCE_DIR/hangover-src/build-arm64ec/Bin/libarm64ecfex.dll" ]; then
                cp "$SOURCE_DIR/hangover-src/build-arm64ec/Bin/libarm64ecfex.dll" $INSTALL_DIR/lib/wine/aarch64-windows/
              fi
              if [ -f "$SOURCE_DIR/hangover-src/build-wow64/Bin/libwow64fex.dll" ]; then
                cp "$SOURCE_DIR/hangover-src/build-wow64/Bin/libwow64fex.dll" $INSTALL_DIR/lib/wine/aarch64-windows/
              fi
              ;;
            box64)
              if [ -f "$SOURCE_DIR/hangover-src/build/wowbox64.dll" ]; then
                mkdir -p $INSTALL_DIR/lib/wine/aarch64-windows/
                cp "$SOURCE_DIR/hangover-src/build/wowbox64.dll" $INSTALL_DIR/lib/wine/aarch64-windows/
              fi
              ;;
            qemu)
              # QEMU 作为 Unix 库使用，不是 DLL
              if [ -f "$SOURCE_DIR/hangover-src/qemu/build/libqemu-i386.so" ]; then
                mkdir -p $INSTALL_DIR/lib/
                cp "$SOURCE_DIR/hangover-src/qemu/build/libqemu-i386.so" $INSTALL_DIR/lib/
              fi
              ;;
          esac
          
          # 设置默认模拟器配置
          echo "HODLL64=libarm64ecfex.dll" > $INSTALL_DIR/share/wine/hangover.conf
          echo "HODLL=libwow64fex.dll" >> $INSTALL_DIR/share/wine/hangover.conf

      - name: Build Proton Components
        if: github.event.inputs.build_target == 'Wine+PE'
        run: |
          cd $SOURCE_DIR/proton-ge-custom
          
          # 构建 dxvk、vkd3d-proton 等组件
          if [ -d "dxvk" ]; then
            cd dxvk
            ./package-release.sh master $INSTALL_DIR --no-package
          fi
          
          if [ -d "vkd3d-proton" ]; then
            cd ../vkd3d-proton
            ./package-release.sh master $INSTALL_DIR --no-package
          fi

      - name: Packaging
        run: |
          PLATFORM="${{ github.event.inputs.platform }}"
          ARCHIVE_TYPE="${{ github.event.inputs.archive_type }}"
          COMPRESSION="${{ github.event.inputs.compression_level }}"
          OUTPUT_NAME="Proton-GE-WoW64-AArch64-${PLATFORM}-$(date +%Y%m%d)"
          
          mkdir -p $GITHUB_WORKSPACE/output
          
          # 处理 DBS/ABS 特殊构建
          if [[ "${{ github.event.inputs.use_dbs }}" == "true" || "${{ github.event.inputs.use_abs }}" == "true" ]]; then
            echo "Using Custom Build System..."
            # 创建符合发行版规范的包
            tar -cf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar -C $INSTALL_DIR .
          else
            cd $INSTALL_DIR
            
            case $ARCHIVE_TYPE in
              tar)
                tar -cvf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar .
                ;;
              tar.xz)
                XZ_OPT="-$COMPRESSION" tar -cJf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.xz .
                ;;
              tar.zst)
                tar --zstd -cf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.zst .
                ;;
              tar.gz)
                tar -czf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.gz .
                ;;
              tar.lz)
                tar --lzip -cf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.lz .
                ;;
              zip)
                zip -r9 $GITHUB_WORKSPACE/output/$OUTPUT_NAME.zip .
                ;;
              *)
                tar -cJf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.xz .
                ;;
            esac
          fi
          
          # 生成构建日志
          {
            echo "Build Log for Proton-GE WoW64 AArch64"
            echo "===================================="
            echo "Build Date: $(date)"
            echo "Platform: $PLATFORM"
            echo "Target: ${{ github.event.inputs.build_target }}"
            echo "Emulator: ${{ github.event.inputs.hangover_emulator }}"
            echo "NTSYNC: ${{ github.event.inputs.enable_ntsync }}"
            echo "FSYNC: ${{ github.event.inputs.enable_fsync }}"
            echo "LTO: ${{ github.event.inputs.disable_lto == 'false' && 'Enabled' || 'Disabled' }}"
            echo "CCache: ${{ github.event.inputs.disable_ccache == 'false' && 'Enabled' || 'Disabled' }}"
            echo ""
            echo "Compiler: $(aarch64-linux-gnu-gcc --version | head -n1)"
            echo "Clang: $(clang --version | head -n1)"
            echo ""
            echo "Wine Configuration:"
            cat $SOURCE_DIR/proton-ge-custom/wine/build-hangover/config.log 2>/dev/null | grep -E "^(configure|CC|CXX|CFLAGS)" || true
          } > $GITHUB_WORKSPACE/output/build.log
          
          # 生成清单文件
          find $INSTALL_DIR -type f | sort > $GITHUB_WORKSPACE/output/manifest.txt

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Proton-GE-WoW64-AArch64-${{ github.event.inputs.platform }}
          path: |
            ${{ github.workspace }}/output/
          retention-days: ${{ github.event.inputs.retention_days == '-1' && '90' || github.event.inputs.retention_days }}
          if-no-files-found: error
