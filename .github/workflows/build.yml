name: Build Proton-GE WoW64 AArch64

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '编译平台'
        required: true
        default: 'Glibc'
        type: choice
        options: [Glibc, Bionic]
      archive_type:
        description: '打包方式'
        required: true
        default: 'tar.xz'
        type: choice
        options: [tar, tar.xz, tar.zst, tar.gz, tar.lz, zip]
      compression_level:
        description: '压缩等级 (1-9)'
        required: false
        default: '9'
      artifact_output:
        description: '打包产物'
        required: true
        default: 'out+log'
        type: choice
        options: [out, log, out+log, bin, bin+log, all]
      retention_days:
        description: '产物存留时间 (天, -1为永久)'
        required: false
        default: '90'
      build_target:
        description: '编译内容'
        required: true
        default: 'Wine+PE'
        type: choice
        options: [Wine+PE, Wine]
      enable_ntsync:
        description: '启用 NTSYNC'
        type: boolean
        default: true
      enable_fsync:
        description: '启用 FSYNC'
        type: boolean
        default: true
      disable_ccache:
        description: '关闭 Ccache'
        type: boolean
        default: false
      disable_lto:
        description: '关闭 LTO'
        type: boolean
        default: false
      exclude_hangover:
        description: '不打包 Hangover 到 Wine'
        type: boolean
        default: false

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  INSTALL_DIR: ${{ github.workspace }}/install
  SOURCE_DIR: ${{ github.workspace }}/sources
  BUILD_DIR: ${{ github.workspace }}/build

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        run: |
          sudo dpkg --add-architecture arm64
          sudo tee /etc/apt/sources.list.d/ubuntu.sources << 'EOF'
          Types: deb
          URIs: http://archive.ubuntu.com/ubuntu/ http://security.ubuntu.com/ubuntu/
          Suites: noble noble-updates noble-backports noble-security
          Components: main restricted universe multiverse
          Architectures: amd64
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg

          Types: deb
          URIs: http://ports.ubuntu.com/ubuntu-ports/
          Suites: noble noble-updates noble-backports noble-security
          Components: main restricted universe multiverse
          Architectures: arm64
          Signed-By: /usr/share/keyrings/ubuntu-archive-keyring.gpg
          EOF
          
          sudo apt-get update
          sudo apt-get install -y ccache clang lld llvm gcc-aarch64-linux-gnu g++-aarch64-linux-gnu binutils-aarch64-linux-gnu mingw-w64 mingw-w64-tools flex bison gettext libpcsclite-dev libvulkan-dev libvulkan1 cmake ninja-build git zstd xz-utils unzip wget
          sudo apt-get install -y libc6:arm64 libstdc++6:arm64 || true

      - name: Install llvm-mingw
        run: |
          LLVM_MINGW_VERSION="20240619"
          LLVM_MINGW_URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz"
          wget -q --show-progress "$LLVM_MINGW_URL" -O /tmp/llvm-mingw.tar.xz
          sudo mkdir -p /opt/llvm-mingw
          sudo tar -xf /tmp/llvm-mingw.tar.xz -C /opt/llvm-mingw --strip-components=1
          
          # 创建 ARM64EC 的编译器软链接修复 CMake 识别问题
          cd /opt/llvm-mingw/bin
          sudo ln -s aarch64-w64-mingw32-clang arm64ec-w64-mingw32-clang
          sudo ln -s aarch64-w64-mingw32-clang++ arm64ec-w64-mingw32-clang++
          sudo ln -s aarch64-w64-mingw32-clang arm64ec-w64-mingw32-gcc
          sudo ln -s aarch64-w64-mingw32-clang++ arm64ec-w64-mingw32-g++
          sudo ln -s aarch64-w64-mingw32-clang arm64ec-w64-mingw32-as
          
          echo "LLVM_MINGW=/opt/llvm-mingw" >> $GITHUB_ENV
          echo "/opt/llvm-mingw/bin" >> $GITHUB_PATH

      - name: Cache Ccache
        if: github.event.inputs.disable_ccache == 'false'
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ github.event.inputs.platform }}-${{ github.sha }}
          restore-keys: ccache-${{ github.event.inputs.platform }}-

      - name: Prepare Sources
        run: |
          mkdir -p $SOURCE_DIR $BUILD_DIR $INSTALL_DIR
          cd $SOURCE_DIR
          git clone --recurse-submodules --depth=1 https://github.com/gloriouseggroll/proton-ge-custom
          if [[ "${{ github.event.inputs.exclude_hangover }}" == "false" ]]; then
            git clone --recurse-submodules --depth=1 https://github.com/AndreRH/hangover.git hangover-src
          fi
          cd proton-ge-custom
          ./patches/protonprep-valve-staging.sh || true

      - name: Build Hangover Emulator DLLs (FEX PE)
        if: github.event.inputs.exclude_hangover == 'false'
        run: |
          export PATH="/opt/llvm-mingw/bin:$PATH"
          cd $SOURCE_DIR/hangover-src
          git submodule update --init --recursive
          
          if [ ! -d "fex" ]; then
            git clone --depth 1 https://github.com/FEX-Emu/FEX.git fex
          fi
          
          LTO_FLAG=${{ github.event.inputs.disable_lto == 'false' && 'True' || 'False' }}
          
          mkdir -p fex/build-arm64ec && cd fex/build-arm64ec
          cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake -DMINGW_TRIPLE=arm64ec-w64-mingw32 -DENABLE_LTO=$LTO_FLAG -DBUILD_TESTING=False -DENABLE_JEMALLOC_GLIBC_ALLOC=False -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR ..
          ninja libarm64ecfex || make -j$(nproc) libarm64ecfex
          
          cd ../..
          mkdir -p fex/build-wow64 && cd fex/build-wow64
          cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake -DMINGW_TRIPLE=aarch64-w64-mingw32 -DENABLE_LTO=$LTO_FLAG -DBUILD_TESTING=False -DENABLE_JEMALLOC_GLIBC_ALLOC=False -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR ..
          ninja libwow64fex || make -j$(nproc) libwow64fex

      - name: Build Wine Native & WoW64 AArch64
        run: |
          export PATH="/opt/llvm-mingw/bin:$PATH"
          cd $SOURCE_DIR/proton-ge-custom/wine
          mkdir -p build-native && cd build-native
          ../configure --prefix=$BUILD_DIR/wine-tools --enable-win64 --disable-tests --without-x --without-wayland --without-vulkan --disable-winevdm
          make -j$(nproc) __tooldeps__ && make install __tooldeps__
          
          cd ../ && mkdir -p build-hangover && cd build-hangover
          CONF_FLAGS="--prefix=$INSTALL_DIR --host=aarch64-linux-gnu --enable-archs=arm64ec,aarch64,i386 --with-mingw=clang --disable-tests"
          [[ "${{ github.event.inputs.platform }}" == "Bionic" ]] && CONF_FLAGS="$CONF_FLAGS --without-x --without-curses --with-vulkan" || CONF_FLAGS="$CONF_FLAGS --with-x --with-vulkan --with-pulse"
          [[ "${{ github.event.inputs.enable_ntsync }}" == "true" ]] && CONF_FLAGS="$CONF_FLAGS --with-ntsync"
          [[ "${{ github.event.inputs.enable_fsync }}" == "true" ]] && CONF_FLAGS="$CONF_FLAGS --with-fsync"
          
          export CC="${{ github.event.inputs.disable_ccache == 'false' && 'ccache ' || '' }}aarch64-linux-gnu-gcc"
          export CXX="${{ github.event.inputs.disable_ccache == 'false' && 'ccache ' || '' }}aarch64-linux-gnu-g++"
          OPT_FLAGS="-O3 -march=armv8.3-a ${{ github.event.inputs.disable_lto == 'false' && '-flto=thin' || '' }}"
          
          export CFLAGS="$OPT_FLAGS" && export CXXFLAGS="$OPT_FLAGS" && export LDFLAGS="-fuse-ld=lld"
          export WINE_TOOLS=$BUILD_DIR/wine-tools
          
          ../configure $CONF_FLAGS
          [[ "${{ github.event.inputs.build_target }}" == "Wine" ]] && make -j$(nproc) || make -j$(nproc) all
          make install

      - name: Merge Hangover Artifacts
        if: github.event.inputs.exclude_hangover == 'false'
        run: |
          mkdir -p $INSTALL_DIR/lib/wine/aarch64-windows/ $INSTALL_DIR/share/wine
          cp -f $SOURCE_DIR/hangover-src/fex/build-arm64ec/Bin/libarm64ecfex.dll $INSTALL_DIR/lib/wine/aarch64-windows/ || true
          cp -f $SOURCE_DIR/hangover-src/fex/build-wow64/Bin/libwow64fex.dll $INSTALL_DIR/lib/wine/aarch64-windows/ || true
          echo -e "HODLL64=libarm64ecfex.dll\nHODLL=libwow64fex.dll" > $INSTALL_DIR/share/wine/hangover.conf

      - name: Build Proton Components
        if: github.event.inputs.build_target == 'Wine+PE'
        run: |
          export PATH="/opt/llvm-mingw/bin:$PATH"
          cd $SOURCE_DIR/proton-ge-custom
          [ -d "dxvk" ] && (cd dxvk && ./package-release.sh master $INSTALL_DIR --no-package)
          [ -d "vkd3d-proton" ] && (cd vkd3d-proton && ./package-release.sh master $INSTALL_DIR --no-package)

      - name: Packaging
        run: |
          OUTPUT_NAME="Proton-GE-WoW64-AArch64-${{ github.event.inputs.platform }}-$(date +%Y%m%d)"
          mkdir -p $GITHUB_WORKSPACE/output $GITHUB_WORKSPACE/staging
          
          # 根据 artifact_output 选择打包内容
          if [[ "${{ github.event.inputs.artifact_output }}" == *"out"* || "${{ github.event.inputs.artifact_output }}" == "all" ]]; then
            cp -r $INSTALL_DIR/* $GITHUB_WORKSPACE/staging/
          fi
          if [[ "${{ github.event.inputs.artifact_output }}" == *"bin"* ]]; then
            mkdir -p $GITHUB_WORKSPACE/staging/bin && cp -r $INSTALL_DIR/bin/* $GITHUB_WORKSPACE/staging/bin/ || true
          fi
          
          if [[ "${{ github.event.inputs.artifact_output }}" != "log" ]]; then
            cd $GITHUB_WORKSPACE/staging
            case ${{ github.event.inputs.archive_type }} in
              tar) tar -cf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar . ;;
              tar.xz) XZ_OPT="-${{ github.event.inputs.compression_level }}" tar -cJf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.xz . ;;
              tar.zst) tar --zstd -cf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.zst . ;;
              tar.gz) tar -czf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.gz . ;;
              tar.lz) tar --lzip -cf $GITHUB_WORKSPACE/output/$OUTPUT_NAME.tar.lz . ;;
              zip) zip -r${{ github.event.inputs.compression_level }} $GITHUB_WORKSPACE/output/$OUTPUT_NAME.zip . ;;
            esac
          fi
          
          # 生成日志
          if [[ "${{ github.event.inputs.artifact_output }}" == *"log"* || "${{ github.event.inputs.artifact_output }}" == "all" ]]; then
            {
              echo "Build Date: $(date)"
              echo "Target: ${{ github.event.inputs.build_target }}"
              cat $SOURCE_DIR/proton-ge-custom/wine/build-hangover/config.log 2>/dev/null | grep -E "^(configure|CC|CXX|CFLAGS)" || true
            } > $GITHUB_WORKSPACE/output/build.log
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Proton-GE-WoW64-AArch64-${{ github.event.inputs.platform }}
          path: ${{ github.workspace }}/output/
          retention-days: ${{ github.event.inputs.retention_days == '-1' && '90' || github.event.inputs.retention_days }}
          if-no-files-found: error
