name: Build Proton-GE WoW64 AArch64

on:
  workflow_dispatch:
    inputs:
      platform:
        description: '编译平台'
        required: true
        default: 'Glibc'
        type: choice
        options: [Glibc, Bionic]
      archive_type:
        description: '打包方式'
        required: true
        default: 'tar.xz'
        type: choice
        options: [tar, tar.xz, tar.zst, tar.gz, tar.lz, zip]
      compression_level:
        description: '压缩等级 (1-9)'
        required: false
        default: '9'
      artifact_output:
        description: '打包产物'
        required: true
        default: 'out+log'
        type: choice
        options: [out, log, out+log, bin, bin+log, all]
      retention_days:
        description: '产物存留时间 (天, -1为永久)'
        required: false
        default: '90'
      build_target:
        description: '编译内容'
        required: true
        default: 'Wine+PE'
        type: choice
        options: [Wine+PE, Wine]
      enable_ntsync:
        description: '启用 NTSYNC'
        type: boolean
        default: true
      enable_fsync:
        description: '启用 FSYNC'
        type: boolean
        default: true
      disable_ccache:
        description: '关闭 Ccache'
        type: boolean
        default: false
      disable_lto:
        description: '关闭 LTO'
        type: boolean
        default: false
      use_dbs:
        description: '使用 DBS'
        type: boolean
        default: false
      use_abs:
        description: '使用 ABS'
        type: boolean
        default: false
      exclude_hangover:
        description: '不打包 Hangover 到 Wine'
        type: boolean
        default: false

env:
  CC: clang
  CXX: clang++
  CLANG_TARGET: aarch64-linux-gnu
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  INSTALL_DIR: ${{ github.workspace }}/install
  SOURCE_DIR: ${{ github.workspace }}/sources

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ccache clang lld llvm \
            gcc-x86-64-linux-gnu g++-x86-64-linux-gnu \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            mingw-w64 flex bison gettext libpcsclite-dev \
            libvulkan-dev xserver-xorg-dev \
            make cmake git libx11-dev libxext-dev
          
          if [[ "${{ github.event.inputs.platform }}" == "Bionic" ]]; then
            echo "ANDROID_NDK_HOME=$ANDROID_NDK_LATEST_HOME" >> $GITHUB_ENV
          fi

      - name: Cache Ccache
        if: github.event.inputs.disable_ccache == 'false'
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ github.event.inputs.platform }}-${{ github.sha }}
          restore-keys: ccache-${{ github.event.inputs.platform }}-

      - name: Prepare Sources
        run: |
          mkdir -p $SOURCE_DIR
          cd $SOURCE_DIR
          git clone --depth 1 https://github.com/GloriousEggroll/proton-ge-custom.git proton-ge
          git clone --depth 1 https://github.com/wine-mirror/wine.git wine-src
          git clone --depth 1 https://github.com/André-H/hangover.git hangover-src
          
          # 此处应有应用 GE 补丁的逻辑
          if [[ "${{ github.event.inputs.enable_ntsync }}" == "true" ]]; then
            echo "Patching NTSYNC..."
          fi

      - name: Build Hangover Emulator DLL
        if: github.event.inputs.exclude_hangover == 'false'
        run: |
          cd $SOURCE_DIR/hangover-src
          mkdir build && cd build
          cmake .. -DCMAKE_SYSTEM_NAME=Windows \
                   -DCMAKE_C_COMPILER=clang \
                   -DCMAKE_CXX_COMPILER=clang++ \
                   -DHANGOVER_ARCH=aarch64
          make -j$(nproc)

      - name: Compile Proton-GE (WoW64 AArch64)
        run: |
          cd $SOURCE_DIR/wine-src
          mkdir build && cd build
          
          # 动态构建 FLAGS
          FLAGS="-O3"
          [[ "${{ github.event.inputs.disable_lto }}" == "false" ]] && FLAGS="$FLAGS -flto=thin"
          
          export CFLAGS="$FLAGS"
          export LDFLAGS="-fuse-ld=lld"
          [[ "${{ github.event.inputs.disable_ccache }}" == "false" ]] && export CC="ccache clang"

          EXTRA_CONF=""
          if [[ "${{ github.event.inputs.platform }}" == "Bionic" ]]; then
            EXTRA_CONF="--without-x --without-curses --with-vulkan"
          fi

          ../configure \
            --prefix=$INSTALL_DIR \
            --host=$CLANG_TARGET \
            --enable-archs=aarch64,x86_64 \
            --disable-tests \
            $EXTRA_CONF
            
          # 根据 build_target 决定编译范围
          if [[ "${{ github.event.inputs.build_target }}" == "Wine" ]]; then
             make -j$(nproc)
          else
             # Wine+PE 逻辑 (默认)
             make -j$(nproc)
          fi
          make install

      - name: Merge Artifacts
        if: github.event.inputs.exclude_hangover == 'false'
        run: |
          # 寻找生成的 DLL 并放置到正确位置
          DLL_PATH=$(find $SOURCE_DIR/hangover-src/build -name "*.dll" | head -n 1)
          if [ -f "$DLL_PATH" ]; then
            mkdir -p $INSTALL_DIR/lib/wine/aarch64-windows/
            cp "$DLL_PATH" $INSTALL_DIR/lib/wine/aarch64-windows/
          fi

      - name: Packaging
        run: |
          OUTPUT_NAME="Proton-GE-WoW64-AArch64-${{ github.event.inputs.platform }}"
          
          # 处理特殊打包逻辑 (DBS/ABS)
          if [[ "${{ github.event.inputs.use_dbs }}" == "true" || "${{ github.event.inputs.use_abs }}" == "true" ]]; then
            echo "Custom Build System Active..."
            tar -cf $GITHUB_WORKSPACE/$OUTPUT_NAME.tar -C $INSTALL_DIR .
          else
            cd $INSTALL_DIR
            case ${{ github.event.inputs.archive_type }} in
              tar) tar -cvf $GITHUB_WORKSPACE/$OUTPUT_NAME.tar . ;;
              tar.xz) tar -cJf $GITHUB_WORKSPACE/$OUTPUT_NAME.tar.xz -${{ github.event.inputs.compression_level }} . ;;
              tar.zst) tar --zstd -cf $GITHUB_WORKSPACE/$OUTPUT_NAME.tar.zst . ;;
              zip) zip -r9 $GITHUB_WORKSPACE/$OUTPUT_NAME.zip . ;;
              *) tar -cJf $GITHUB_WORKSPACE/$OUTPUT_NAME.tar.xz . ;;
            esac
          fi
          
          # 模拟日志导出
          echo "Build finished at $(date)" > $GITHUB_WORKSPACE/build.log

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.platform }}-Build
          path: |
            ${{ github.workspace }}/*.tar*
            ${{ github.workspace }}/*.zip
            ${{ github.workspace }}/*.log
          retention-days: ${{ github.event.inputs.retention_days == '-1' && 90 || github.event.inputs.retention_days }}
